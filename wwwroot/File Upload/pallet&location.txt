const { useState, useEffect, useRef } = React;
const { Table, Button, Input, Space, Col, Card, message, Select, Form, Row, AutoComplete, DatePicker, Upload, Switch, Spin, Modal, InputNumber, Divider } = antd;
const { SearchOutlined, DownOutlined, SaveOutlined, EditOutlined, DeleteOutlined, HomeOutlined, PlusOutlined, PushpinOutlined, ProfileOutlined, PaperClipOutlined, MailOutlined, FileTextOutlined, CheckCircleTwoTone, UploadOutlined, FileOutlined } = icons;

var recordData;
var states = [];
function Warehouse() {
    const { Option } = Select;
    const [form] = Form.useForm();
    const [warehouseData, setWarehouseData] = useState([]);
    const [loading, setLoading] = useState(true);
    const [loading3, setLoading3] = useState(false);
    const [loading6, setLoading6] = useState(false);
    const [selectedRecord, setSelectedRecord] = useState(null);
    const [isEditMode, setIsEditMode] = useState(false);
    const [isCancelHovered, setIsCancelHovered] = useState(false);// Add state for edit mode
    const [searchTerm, setSearchTerm] = useState(''); // State to hold the search term
    const [filteredWarehouseData, setFilteredWarehouseData] = useState([]);
    const [isEnabled, setIsEnabled] = useState(true);
    const [countries, setCountries] = useState([]);
    const [selectedCountry, setSelectedCountry] = useState('');
    //const [states, setStates] = useState([]);
    const [loading2, setLoading2] = useState(false);
    const [loading1, setLoading1] = useState(false);

    // State to hold filtered data
    // Function to handle search input change
    const handleSearch = (value) => {
        if (warehouseData && warehouseData.length > 0) {
            const filteredData = warehouseData.filter((item) =>
                (item.warehousename && item.warehousename.toLowerCase().includes(value.toLowerCase())) ||
                (item.phone && item.phone.toLowerCase().includes(value.toLowerCase())) ||
                (item.email && item.email.toLowerCase().includes(value.toLowerCase()))
            );
            setSearchTerm(value); // Update search term state
            setFilteredWarehouseData(filteredData); // Update filtered data state
        }
    };
    useEffect(() => {
        // Fetch warehouse data when component mounts
        handleWarehouseDataFetch();
        fetchCountries();
    }, []);

    const fetchCountries = () => {
        setLoading2(true); // Set loading to true before the API call
        $.ajax({
            url: "/Base/LoadOrigin", // Adjust URL as per your API endpoint
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log('API Response:', data); // Log the response for debugging
                if (Array.isArray(data)) {
                    const countryNames = data.map(item => item.country1); // Extract country names from API response
                    setCountries(countryNames); // Update state with country names
                } else {
                    console.error('Unexpected data format:', data);
                }
            },
            error: function (error) {
                console.error('Error fetching countries:', error);
            },
            complete: function () {
                setLoading2(false); // Set loading to false after the API call is complete
            }
        });
    };
    // Function to fetch states by country
    const loadStatesByCountry = async (country) => {
        try {
            setLoading1(true);
            form.setFieldsValue({ state: null });
            const response = await $.ajax({
                url: `Base/LoadStatesByCountry?cText=${country}`,
                type: "GET",
            });
            const sortedStates = response.sort((a, b) => a.statename.localeCompare(b.statename));
            sortedStates.map((e) => {
                states.push(e);
            })
            if (states.length > 0) {
                var findState = states.find((f) => f.statename.toLowerCase() === recordData?.state.toLowerCase());
                if (findState) {
                  form.setFieldsValue({ state: findState?.state1 });
                }
            } else {
                form.setFieldsValue({ state: null });
            }
        } catch (err) {
            message.error(`Error: ${err.message}`);
        } finally {
            setLoading1(false);
        }
    };
    // Call this function when a country is selected
    const handleCountryChange = async (value) => {
        form.setFieldsValue({ state: undefined });
        console.log('value', value);
        setSelectedCountry(value);
        //handleEdit();
        states = [];
        loadStatesByCountry(value);
    };

    // Render function for state dropdown or input field based on states array
    const renderStateField = () => {
        //if (loading1) {
        //    return <Spin />;
        //}

        if (states && states.length > 0) {
            return (
                <Select
                   
                    placeholder="Select state"
                    style={{ width: '258px' }}
                    loading={loading1}
                    showSearch
                    filterOption={(inputValue, option) =>
                        option.children.toLowerCase().indexOf(inputValue.toLowerCase()) >= 0
                    }
                   
                >
                    {states.map(state => (
                        <Option key={state.state1} value={state.state1}>
                            {state.statename}
                        </Option>
                    ))}
                </Select>
            );
        } else {
            // Simulate a transition delay for illustration purposes
            return (
                <div style={{ position: 'relative', width: '258px' }}>
                    <Input placeholder="Enter state" />
                    {loading1 && (
                        <div
                            style={{
                                position: 'absolute',
                                top: '50%',
                                right: '10px',
                                transform: 'translateY(-50%)'
                            }}
                        >
                            <Spin size="small" />
                        </div>
                    )}
                </div>
            );
        }
    };


    // Example usage in the Select component
    const pagination = {
        defaultPageSize: 10,
        showTotal: (total, range) => `${range[0]}-${range[1]} of ${total} Items`
    }
    const handleWarehouseDataFetch = () => {
        setLoading(true); // Set loading state to true while fetching
        $.ajax({
            url: 'Warehouse/GetWarehouselist',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log(data.data);
                if (data.responsecode === 200) {
                    setWarehouseData(data.data);
                } else {
                    console.error('Unexpected data format:', data);
                }
                setLoading(false); // Set loading state to false after fetching
            },
            error: function (error) {
                console.error('Error fetching warehouse data:', error);
                setLoading(false); // Set loading state to false on error
            }
        });
    };
    const handleSubmit = async () => {
        try {
            setLoading6(true);
            const values = await form.validateFields();
            console.log('selectedRecord', selectedRecord)
            console.log('values', values);
            const whmodel = {
                warehousename: values.warehousename,
                Address: values.address,
                City: values.city,
                State: values.state,
                Postalcode: values.postalcode,
                Phone: values.phone,
                Email: values.email,
                Contactname: values.Contactname, 
                country: values.country,
                DefaultPallet: values.defaultPallet ||null,
                DefaultLocation: values.defaultLocation || null,
                IsActive: isEnabled, 
                whid: selectedRecord ? selectedRecord.uniqueid : null // Use the ID if editing an existing record
            };
            console.log('whmodel', whmodel);
            const url = "/Warehouse/Createandupdatewarehouses/"; // Ensure this endpoint is for updating
            await $.ajax({
                type: "POST",
                url: url,
                data: { _whmodel: whmodel },
                success: function (data) {
                    console.log('data', data);
                    setLoading6(false);
                    if (data.responsecode === 200) {
                        swal("Success", isEditMode ? "Warehouse Updated successfully" : "New Warehouse Added successfully", "success");
                        form.resetFields('');
                        //setStates([]);
                        states = [];
                        setCountries([]);
                        handleWarehouseDataFetch();
                        setIsEditMode(false); // Reset edit mode
                        setSelectedRecord(null); // Reset selected record
                    }
                    else {
                    // Show the message from the server response
                    swal("Error", data.responsemessage);
                }
                },
                error: function (result) {
                    setLoading6(false);
                    $("#start-loading").loading("stop");
                    swal({
                        title: "Server Error",
                        text: result.responseText, // Use result.responseText for more detailed error info
                    });
                }
            });
        } catch (error) {
            setLoading6(false);
            console.error('Validation failed:', error);
            swal("Error", "Validation failed. Please check your input.", "error");
        }
    };
    const handleCancel = () => {
        form.resetFields();
        setIsEditMode(false);
        states = [];
    };

    const handleEdit = async (record, value) => {
        setLoading3(true);
        setCountries([]);
        console.log('Edit record:', record);
        recordData = record;
        setSelectedRecord(record);
        // Fetch countries first to ensure dropdown is populated
        await fetchCountries();
        form.setFieldsValue({
            warehousename: record.warehousename,
            Contactname: record.contactname,
            address: record.address,
            city: record.city,
            country: record.country,
            //state: record.statename,
            postalcode: record.postalcode,
            phone: record.phone,
            email: record.email,
            defaultPallet: record.defaultPallet,
            defaultLocation: record.defaultLocation,
        });
        form.setFieldsValue(record.contactname);
        if (record.country !== null) {
         
            handleCountryChange(record.country);

            form.setFieldsValue(record);
          ;
        } else {
            handleCountryChange();
            form.setFieldsValue({ country: null, state: null });
            //setStates([]);
            states = [];
        }
        setIsEditMode(true);
        setTimeout(() => {
            setLoading3(false);
        }, 3000);
    };

    const columns = [
        {
            title: 'Warehouse Name',
            dataIndex: 'warehousename',
            key: 'Warehouse Name',
        },
        {
            title: 'Phone',
            dataIndex: 'phone',
            key: 'Phone',
        },
        {
            title: 'Email',
            dataIndex: 'email',
            key: 'Email',
        },
        {
            title: 'Pallet',
            dataIndex: 'defaultPallet',
            key: 'Pallet',
        },
        {
            title: 'Location',
            dataIndex: 'defaultLocation',
            key: 'Location',
        },

        {
            title: 'Action',
            key: 'action',
            align:'center',
            render: (text, record) => (
                <EditOutlined onClick={() => handleEdit(record)} style={{ color: '#1890ff', fontSize: '16px' }} />
            ),
        },
    ];
    const handleCancelMouseEnter = () => setIsCancelHovered(true);
    const handleCancelMouseLeave = () => setIsCancelHovered(false);

    return (
        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <div style={{ flex: 1, padding: '16px', borderRadius: '8px', marginRight: '16px' }}>
                <Spin spinning={loading3} style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
                    <Form
                        name="basic"
                        form={form}
                 
                        //initialValues={{ remember: true }}
                    >
                        <div style={{ display: 'flex', justifyContent: "space-between", alignItems: 'center', marginBottom: '-16px' }}>
                            <div style={{ display: 'flex', alignItems: 'center' }}>
                                <HomeOutlined style={{ marginRight: '8px', fontSize: '24px', color: '#9370DB', verticalAlign: 'middle' }} />
                                <h2 style={{ color: '#9370DB', fontWeight: '500', fontSize: '18px', marginTop: '20px' }}>
                                    Warehouse Management
                                </h2>
                            </div>
                            <Switch
                                style={{ marginTop:'12px' }}
                                checked={isEnabled}
                                onChange={setIsEnabled}
                                checkedChildren="ON"
                                unCheckedChildren="OFF"
                                defaultChecked={false} // Initial state of the switch
                            /> 
                        </div>
                        <Divider />
                   
                        <div>
                            <Row gutter={[30, 8]} style={{ paddingLeft: 0 }}>
                                <Col span={8}>
                                    <Form.Item
                                        label="Warehouse Name"
                                        name="warehousename"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter warehouse name!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter warehouse name" />
                                    </Form.Item>
                                </Col>
                                <Col span={8}>
                                    <Form.Item
                                        label="Contact Name"
                                        name="Contactname"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter contactname!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter contactname" />
                                    </Form.Item>
                                </Col>
                            </Row>
                        </div>
                        <Divider />
                        <div>
                            <Row gutter={[30, 8]} style={{ paddingLeft: 0 }}>
                                <Col span={8}>
                                    <Form.Item
                                        label="Address"
                                        name="address"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter address!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter address" />
                                    </Form.Item>
                                </Col>
                                <Col span={8}>
                                    <Form.Item
                                        label="City"
                                        name="city"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter city!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter City" />
                                    </Form.Item>
                                </Col>
                                <Col span={8}>
                                    <Form.Item
                                        label="Country"
                                        name="country"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'please select country!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Select
                                            showSearch
                                            placeholder="select country"
                                            style={{ width: '258px' }}
                                            onChange={handleCountryChange}                                       
                                            loading={loading2}
                                        >
                                              {countries.map(country1 => (
                                    <Option key={country1} value={country1}>{country1}</Option>
                                ))}
                                        </Select>
                                    </Form.Item>
                                </Col>
                                <Col span={8}>
                                    <Form.Item
                                        label="State"
                                        name="state"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter state!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        {renderStateField()}
                                    </Form.Item>
                                </Col>
                           
                                <Col span={8}>
                                    <Form.Item
                                        label="Postal Code"
                                        name="postalcode"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter postal code!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter postal code"/>
                                    </Form.Item>
                                </Col>
                                <Col span={8}>
                                    <Form.Item
                                        label="Phone"
                                        name="phone"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter phone number!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter phone number" />
                                    </Form.Item>
                                </Col>
                                <Col span={8}>
                                    <Form.Item
                                        label="Email"
                                        name="email"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter email!' }, { type: 'email', message: 'Please enter a valid email!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter email" />
                                    </Form.Item>
                                </Col>
                            </Row>
                        </div>
                        <Divider />
                        <div>
                            <Row gutter={[30, 8]} style={{ paddingLeft: 0 }}>
                                <Col span={8}>
                                    <Form.Item
                                        label="Default Pallet"
                                        name="defaultPallet"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter pallet" />
                                    </Form.Item>
                                </Col>
                                <Col span={8}>
                                    <Form.Item
                                        label="Default Warehouse Location"
                                        name="defaultLocation"
                                        labelCol={{ span: 24, style: { fontWeight: '500', marginBottom: '-5px' } }}
                                        wrapperCol={{ span: 24, style: { paddingLeft: 0 } }}
                                        rules={[{ required: true, message: 'Please enter Location!' }]}
                                        style={{ marginBottom: '5px' }}
                                    >
                                        <Input placeholder="Enter location" />
                                    </Form.Item>
                                </Col>
                            </Row>
                        </div>

                        <div style={{ alignItems: 'center', marginTop: 20 }}>
                            <div style={{ display: 'flex', justifyContent: 'flex-end' }}>
                                <Button type="primary" htmlType="submit" onClick={handleSubmit} loading={loading6}>
                                    {isEditMode ? 'Update' : 'Add'}
                                </Button>
                                <Button
                                    style={{
                                        marginLeft: 10,
                                        backgroundColor: isCancelHovered ? '#FFA000' : '#FFC107',
                                        borderColor: isCancelHovered ? '#FFA000' : '#FFC107',
                                        color: 'white',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }}
                                    onMouseEnter={handleCancelMouseEnter}
                                    onMouseLeave={handleCancelMouseLeave}
                                    onClick={handleCancel}
                                >
                                    Cancel
                                </Button>
                            </div>
                        </div>

                    </Form>
                </Spin>
            </div>
            <div style={{ flex: 1, padding: '16px', borderRadius: '8px', marginBottom: '0px' }}>
                <div style={{ display: 'flex', alignItems: 'flex-end', marginBottom: '20px', marginTop:'15px' }}>
                    <ProfileOutlined style={{ marginRight: '8px', fontSize: '24px', marginBottom: '-4px', color: '#9370DB' }} />
                    <h2 style={{ color: '#9370DB', fontWeight: '500', fontSize: '18px', marginBottom: '-6px' }}>
                        Warehouses List
                    </h2>
                </div>


                <Divider />
                <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '8px' }}>
                    <div>
                        <AutoComplete
                            style={{
                                width: "12em",
                                paddingRight: "6px",
                                paddingBottom: "3px"
                            }}
                            placeholder="Search by..."
                            onSearch={handleSearch}
                        />
                    </div>
                </div>
                <Table
                    columns={columns}
                    dataSource={searchTerm ? filteredWarehouseData : warehouseData}
                    loading={loading}
                    rowKey="id" 
                    pagination={pagination}
                    bordered
                    size="small"
                />
            </div>
        </div>
    );

};
ReactDOM.render(<Warehouse />, document.getElementById("Transfer_React"));